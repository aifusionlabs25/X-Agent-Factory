# New Prospect Pipeline
# Triggered from Dashboard via workflow_dispatch
# URL -> Intake -> Build -> Security Eval -> Deploy (optional)
# v1.1: Added failure-stage reporting and network retries

name: New Prospect Pipeline

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Prospect website URL'
        required: true
        type: string
      deploy_env:
        description: 'Deploy environment (staging/off)'
        required: false
        default: 'off'
        type: choice
        options:
          - 'off'
          - 'staging'
          - 'production'
      expert_mode:
        description: 'Enable Expert Mode (Troy Pass)'
        required: false
        default: false
        type: boolean
      kb_builder:
        description: 'Enable KB Library Builder'
        required: false
        default: true
        type: boolean

env:
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  TAVUS_API_KEY: ${{ secrets.TAVUS_API_KEY }}
  ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}

# Explicit permissions for GITHUB_TOKEN
permissions:
  contents: write
  actions: read

jobs:
  intake-build-deploy:
    runs-on: ubuntu-latest
    
    outputs:
      failure_stage: ${{ steps.failure_report.outputs.stage }}
      failure_reason: ${{ steps.failure_report.outputs.reason }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest trafilatura beautifulsoup4 requests jsonschema pyyaml

      # ============================================
      # STEP 1: INTAKE (with retry for network issues)
      # ============================================
      - name: Step 1 - Intake Spider and Package
        id: intake
        continue-on-error: true
        run: |
          echo "::group::Intake Spider"
          echo "Spidering: ${{ inputs.url }}"
          
          # Retry logic for network fetch (2 attempts with backoff)
          MAX_RETRIES=2
          RETRY_DELAY=10
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES"
            if python tools/intake_packager.py --url "${{ inputs.url }}" --output intake_output.json --no-log; then
              echo "intake_success=true" >> $GITHUB_OUTPUT
              break
            else
              if [ $attempt -lt $MAX_RETRIES ]; then
                echo "Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "intake_success=false" >> $GITHUB_OUTPUT
                echo "intake_error=Network/Parse failure after $MAX_RETRIES attempts" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          done
          
          # Extract slug from output
          SLUG=$(python -c "import json; print(json.load(open('intake_output.json'))['slug'])")
          DOSSIER_PATH=$(python -c "import json; print(json.load(open('intake_output.json'))['dossier_path'])")
          
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "dossier_path=$DOSSIER_PATH" >> $GITHUB_OUTPUT
          echo "Intake complete: $SLUG"
          echo "::endgroup::"

      - name: Check Intake Result
        if: steps.intake.outcome == 'failure'
        run: |
          echo "FAILURE_STAGE=intake" >> $GITHUB_ENV
          echo "FAILURE_REASON=fetch_parse_error" >> $GITHUB_ENV
          echo "❌ INTAKE FAILED: Could not fetch or parse ${{ inputs.url }}"
          exit 1

      # ============================================
      # STEP 2: BUILD AGENT (with retry)
      # ============================================
      - name: Step 2 - Build Agent (Baseline)
        id: build
        continue-on-error: true
        run: |
          echo "::group::Build Agent"
          echo "Building agent for: ${{ steps.intake.outputs.slug }}"
          
          # Retry logic for build (1 retry for transient AI API issues)
          MAX_RETRIES=2
          RETRY_DELAY=5
          
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES"
            if python tools/factory_orchestrator.py --build-agent "${{ steps.intake.outputs.dossier_path }}" --no-log; then
              echo "build_success=true" >> $GITHUB_OUTPUT
              break
            else
              if [ $attempt -lt $MAX_RETRIES ]; then
                echo "Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "build_success=false" >> $GITHUB_OUTPUT
                echo "build_error=Build failed after $MAX_RETRIES attempts" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          done
          
          # Derive agent_slug from dossier (same logic as factory_orchestrator.compute_client_slug)
          ACTUAL_SLUG=$(python -c "import json, re; d=json.load(open('${{ steps.intake.outputs.dossier_path }}')); n=d.get('client_profile',{}).get('name',''); s=re.sub(r'[\s_-]+','_',re.sub(r'[^\w\s-]','',n.lower().strip())); print(s)")
          if [ -z "$ACTUAL_SLUG" ]; then
            echo "❌ Could not derive agent slug from dossier!"
            exit 1
          fi
          echo "agent_slug=$ACTUAL_SLUG" >> $GITHUB_OUTPUT
          echo "Agent built: $ACTUAL_SLUG"
          echo "::endgroup::"

      - name: Check Build Result
        if: steps.build.outcome == 'failure'
        run: |
          echo "FAILURE_STAGE=build" >> $GITHUB_ENV
          echo "FAILURE_REASON=build_error" >> $GITHUB_ENV
          echo "❌ BUILD FAILED"
          exit 1

      # ============================================
      # STEP 2.5: EXPERT PROMPT WRITER (OPTIONAL)
      # ============================================
      - name: Step 2.5 - Expert Prompt Writer (Troy Pass)
        id: epw
        if: ${{ inputs.expert_mode == true && steps.build.outcome == 'success' }}
        continue-on-error: true
        run: |
          echo "::group::Expert Prompt Writer"
          echo "Running Troy Pass for: ${{ steps.build.outputs.agent_slug }}"
          python tools/expert_prompt_writer.py --slug "${{ steps.build.outputs.agent_slug }}"
          echo "::endgroup::"

      # ============================================
      # STEP 3: SECURITY GATE (NO RETRIES - hard gate)
      # ============================================
      - name: Step 3 - Security Evaluation HARD GATE
        id: security
        continue-on-error: true
        run: |
          echo "::group::Security Evaluation"
          echo "Running security evaluation..."
          python tools/eval_runner.py --suite security_injection --ci
          
          # Check for pass
          PASSED=$(python -c "import json; r=json.load(open('eval-report.json')); print(r['total_failed'])")
          
          if [ "$PASSED" != "0" ]; then
            echo "security_success=false" >> $GITHUB_OUTPUT
            echo "security_failed_count=$PASSED" >> $GITHUB_OUTPUT
            echo "SECURITY GATE FAILED: $PASSED tests failed"
            exit 1
          fi
          
          echo "security_success=true" >> $GITHUB_OUTPUT
          echo "Security: 12/12 PASS"
          echo "::endgroup::"

      - name: Check Security Result
        if: steps.security.outcome == 'failure'
        run: |
          echo "FAILURE_STAGE=security" >> $GITHUB_ENV
          echo "FAILURE_REASON=security_gate_failed" >> $GITHUB_ENV
          echo "❌ SECURITY GATE FAILED - NO RETRY ALLOWED"
          echo "Deployment blocked - fix security issues before retrying"
          exit 1

      - name: Step 2.5 - KB Library Builder (Optional)
        if: inputs.kb_builder == true && steps.build.outputs.build_success == 'true'
        id: kb_builder
        run: |
          echo "::group::KB Library Builder"
          echo "Building KB for: ${{ steps.build.outputs.agent_slug }}"
          echo "Using dossier: ${{ steps.intake.outputs.dossier_path }}"
          
          if python tools/kb_library_builder.py --slug "${{ steps.build.outputs.agent_slug }}" --dossier "${{ steps.intake.outputs.dossier_path }}"; then
             echo "kb_success=true" >> $GITHUB_OUTPUT
             echo "KB Build Complete"
          else
             echo "kb_success=false" >> $GITHUB_OUTPUT
             echo "KB Build Failed (Non-blocking)"
          fi
          echo "::endgroup::"
      
      # ============================================
      # STEP 3.5: ADVISORY EVAL (OPTIONAL)
      # ============================================
      - name: Step 3.5 - Advisory Eval (Expert Mode)
        if: ${{ inputs.expert_mode == true }}
        continue-on-error: true
        run: |
          echo "::group::Advisory Eval"
          echo "Running advisory style/functional evals..."
          # Run functional eval
          if [ -f "evals/functional.jsonl" ]; then
             python tools/eval_runner.py --suite functional --ci || echo "Functional eval failed (advisory)"
          fi
          # Run style eval
          if [ -f "evals/style.jsonl" ]; then
             python tools/eval_runner.py --suite style --ci || echo "Style eval failed (advisory)"
          fi
          echo "::endgroup::"

      # ============================================
      # STEP 4: DEPLOY (optional)
      # ============================================
      - name: Step 4 - Deploy to Staging
        if: ${{ inputs.deploy_env != 'off' && steps.security.outcome == 'success' }}
        run: |
          echo "::group::Deploy"
          echo "Deploying to: ${{ inputs.deploy_env }}"
          python tools/deployer.py --deploy "agents/${{ steps.build.outputs.agent_slug }}" --env "${{ inputs.deploy_env }}" --no-log
          echo "Deployed"
          echo "::endgroup::"

      # ============================================
      # STEP 5: COMMIT (with retry for push conflicts)
      # ============================================
      - name: Step 5 - Commit Results
        id: commit
        continue-on-error: true
        run: |
          echo "::group::Commit Results"
          git config user.name "X Agent Factory Bot"
          git config user.email "factory-bot@aifusionlabs.ai"
          
          # Add generated files
          git add agents/ ingested_clients/ runs/ eval-report.json || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "commit_success=true" >> $GITHUB_OUTPUT
          else
            # Retry push with pull-rebase for conflicts
            MAX_RETRIES=2
            for attempt in $(seq 1 $MAX_RETRIES); do
              echo "Push attempt $attempt of $MAX_RETRIES"
              # Construct Commit Message
              COMMIT_MSG="New Prospect: ${{ steps.intake.outputs.slug }}"
              if [[ "${{ inputs.expert_mode }}" == "true" ]]; then
                COMMIT_MSG="$COMMIT_MSG [EXPERT]"
              fi
              if [[ "${{ inputs.kb_builder }}" == "true" ]]; then
                COMMIT_MSG="$COMMIT_MSG [KB]"
              fi
              
              git commit -m "$COMMIT_MSG from ${{ inputs.url }}" || true
              if git push origin main; then
                echo "commit_success=true" >> $GITHUB_OUTPUT
                echo "Changes committed and pushed"
                break
              else
                if [ $attempt -lt $MAX_RETRIES ]; then
                  echo "Push failed, pulling with rebase..."
                  git pull --rebase origin main
                else
                  echo "commit_success=false" >> $GITHUB_OUTPUT
                  exit 1
                fi
              fi
            done
          fi
          echo "::endgroup::"

      - name: Check Commit Result
        if: steps.commit.outcome == 'failure'
        run: |
          echo "FAILURE_STAGE=push" >> $GITHUB_ENV
          echo "FAILURE_REASON=push_403_or_conflict" >> $GITHUB_ENV
          echo "❌ PUSH FAILED"
          exit 1

      # ============================================
      # FAILURE REPORT (runs on any failure)
      # ============================================
      - name: Failure Report
        id: failure_report
        if: failure()
        run: |
          echo "stage=${FAILURE_STAGE:-unknown}" >> $GITHUB_OUTPUT
          echo "reason=${FAILURE_REASON:-unknown}" >> $GITHUB_OUTPUT
          
          echo "## ❌ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | ${FAILURE_STAGE:-unknown} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reason | ${FAILURE_REASON:-unknown} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ inputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failure Categories" >> $GITHUB_STEP_SUMMARY
          echo "- **intake**: fetch_parse_error, timeout" >> $GITHUB_STEP_SUMMARY
          echo "- **build**: build_error, api_timeout" >> $GITHUB_STEP_SUMMARY
          echo "- **security**: security_gate_failed (NO RETRY)" >> $GITHUB_STEP_SUMMARY
          echo "- **push**: push_403_or_conflict" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # SUCCESS SUMMARY
      # ============================================
      - name: Summary
        if: success()
        run: |
          echo "## ✅ Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|:-----|:-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mode | ${{ inputs.expert_mode == true && 'Expert (Troy)' || 'Baseline' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Intake | ${{ steps.intake.outputs.slug }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | 12/12 PASS |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ inputs.deploy_env }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source URL:** ${{ inputs.url }}" >> $GITHUB_STEP_SUMMARY
